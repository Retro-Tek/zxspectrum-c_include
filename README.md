zxspectrum - c_include
======================

**IMPORTANT: This code WILL NOT work properly on Windows!**

Synopsis
--------
With this library, you will be able to write parts of your ZX-Spectrum program using C and include them into the ASM source, when using SjAsmPlus as a build tool. You will need an SDCC or Z88DK (for ZSDCC) to translate C code into ASM code, but a machine code generation can be done completely by SjAsmPlus, without using SDCC or Z88DK toolchains.

Symbols defined in C code can be accessed from the rest of the code as usual labels. And vice versa: labels can be accessed from C code using 'extern' declaration. Also, there is a special mechanism to pass 'defines' into the C code.

NOTE: Although this system proved to be working, it is heavily dependant on the undocumented implementation details of both SjAsmPlus and SDCC/ZSDCC that can change in the future. USE THIS LIBRARY AT YOUR OWN RISK!

Example
-------
**main.asm:**
```
    include "c_include.inc"
    ...
    call my_proc
    ...
some_var dw 0
    ...
    c_define "IS_16BIT"
    c_define "SOME_VALUE" = 123

    c_include "module.c"
    ...
    include "crt0.asm" ; Needed for integer multiplication/division/modulus operators.
```

**module.c:**
```
#ifdef IS_16BIT
extern int some_var;
#else
extern char some_var;
#endif

void my_proc()
{
    some_var = SOME_VALUE;
}
```

Warnings & Limitations:
-----------------------
* This code WILL NOT work properly on Windows due to a bug in SjAsmPlus and this CANT be fixed for now. LUA`s sj.shellexec procedure is implemented via WinExec on Windows, which makes it asynchronous. Which, in turn, makes it nearly useless.
* Generally, operability of this code heavily depends on the specific behavior of SjAsmPlus and SDCC compilers, (particularly on the ability of SjAsmPlus to understand z80asm syntax), so there are ABSOLUTELY NO GUARANTEES that it will not break with the next update of any of them, nor that it could be fixed. Currently only SjAsmPlus-v1.18.3 + SDCC-4.1.0/ZSDCC-4.0.7 (all Linux) were tested.
* Only 8-bit and 16-bit integers are fully supported.
* Floating-point numbers are not (and will never be) supported.
* Global variables initialization will not work. They are always set to zero.
* Functions defined with 'static' modifier are still visible from everywhere (just like when ordinary including C sources).
* CRT0 is minimalistic and contains only MUL/DIV/MOD routines for 8-bit/16-bit integers. This code was extracted from SDCC. See a note about licensing issues below.


License
-------
While the library itself is shipped under the terms of MIT license, the 'crt0.asm' file is an exception.
Because this file contains code extracted from SDCC, it is subject of GNU GPL v3 license.
For ones who care - if you do not want your program to suddenly become a GPL software, you have two options:
* Do not include 'crt0.asm' file. This will prevent you from using 16-bit '\*', '/', '%' operators and 8-bit '/', '%' operators. Note that 8-bit '\*' operators (both signed and unsigned versions) are generated by the compiler itself.
* Write necessary routines by yourself (you can add the support of 32/64-bit integers or even float/double this way if you want).

